<!DOCTYPE html>
<html>

<head>
  
<meta charset='utf-8'>
<meta http-equiv="X-UA-Compatible" content="chrome=1">

<!-- CSS -->
<link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="/chrome_todo/stylesheets/stylesheet.css" media="screen" />
<link rel="stylesheet" type="text/css" href="/chrome_todo/stylesheets/pygment_trac.css" media="screen" />
<link rel="stylesheet" type="text/css" href="/chrome_todo/stylesheets/print.css" media="print" />
<script src="/chrome_todo/javascripts/popup.js""></script>

<!--[if lt IE 9]>
<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->

<title>Step 7 - Using Chrome's Storage API</title>

</head>

<body>
  <div id="container">
    <div class="inner">
      <header>
        <h1><a href="/chrome_todo/">Chrome ToDo</a></h1>
        <h2>A simple packaged Chrome ToDo app and a tutorial on how to get started...</h2>
      </header>

      <section id="downloads" class="clearfix">
    <a href="https://github.com/schaazzz/chrome_todo/archive/master.zip" id="download-zip" class="button"><span>Download .zip</span></a>
    <a href="https://github.com/schaazzz/chrome_todo/archive/master.tar.gz" id="download-tar-gz" class="button"><span>Download .tar.gz</span></a>
    <a href="https://github.com/schaazzz/chrome_todo/" id="view-on-github" class="button"><span>View on GitHub</span></a>
</section>

      <hr/>

      <section id="main_content">
        <header class="post-header">
    <h1>Step 7 - Using Chrome's Storage API</h1>
    <p class="meta">Jun 4, 2015 â€¢ Shahzeb Ihsan</p>
</header>


<section id = "blanket" style = "display:none;">
</section>

<section id = "popup" style = "display:none;">
    <img id = image src="">
</section>

<p><a href="/chrome_todo/2015/06/02/styling-with-css/">Previous Step: Styling with CSS</a></p>

<p>First things first, lets get the permissions out of the way, add the following line to <strong>background.js</strong>:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="s2">&quot;permissions&quot;</span> <span class="o">:</span> <span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]</span></code></pre></div>

<p><a href="https://developer.chrome.com/extensions/storage">chrome.storage</a> is relatively simple, with only calls to &quot;set&quot; and &quot;get&quot; required for writing and reading, respectively. Since <strong>chrome.storage</strong> is asynchronous, a callback function has to be provided during &quot;set&quot; and &quot;get&quot; calls for notification of when the storage operation is complete.</p>

<p>In <strong>application.js</strong>, we add code to save data currently displayed in the textarea using a key/value pair, the key is &quot;todos&quot; and the value is what is currently displayed in the textarea. The modified <strong>application.js</strong> script:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;enter&#39;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;\r\n&#39;</span><span class="p">;</span>
        <span class="nx">txt</span> <span class="o">+=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">txt</span><span class="p">;</span>

        <span class="nx">chrome</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">sync</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s1">&#39;todos&#39;</span><span class="o">:</span> <span class="nx">txt</span><span class="p">},</span>
            <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;todos saved...&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span></code></pre></div>

<p>Let&#39;s relaunch the application and check if this works. Once open:
- right click anywhere on the app and click &quot;Inspect element&quot; and in the &quot;Developer Tools&quot; window go to the &quot;Console&quot; tab
- enter something in the input and click enter
- in the &quot;Developer Tools&quot; window, go to the &quot;Storage Explorer&quot; tab and select &quot;chrome.storage.sync&quot; and check the contents</p>

<p><a href = javascript:void(0); onclick=popup("/chrome_todo/images/set_animation.gif");>Click image to open larger version<img src="/chrome_todo/images/set_animation.gif" alt="Saving data using chrome.storage.sync.set"></a></p>

<p>Loading the data at startup and repopulating the text area is slightly more complex. We want to load stored data as early as possible so we can initialize the textarea with these values. The tricky part is copying the data from the background page to the window. First, lets get the straight forward part out of the way, we&#39;ll read back the data in <strong>background.js</strong> as follows:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">stored_todos</span><span class="p">;</span>

<span class="nx">chrome</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">onLaunched</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Read data from storage</span>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">sync</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;todos&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">todos</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">stored_todos</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">stored_todos</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">todos</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>

    <span class="c1">// Create the HTML view</span>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nb">window</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s1">&#39;window.html&#39;</span><span class="p">,</span>
                             <span class="p">{</span><span class="s1">&#39;bounds&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;width&#39;</span><span class="o">:</span> <span class="mi">505</span><span class="p">,</span> <span class="s1">&#39;height&#39;</span><span class="o">:</span> <span class="mi">565</span><span class="p">}});</span>
<span class="p">});</span></code></pre></div>

<p>Reload the app, right click anywhere and click &quot;Inspect background page&quot; and go to the &quot;Console&quot; tab, you should see the value we wrote in the last step in the console:</p>

<p><img src="/chrome_todo/images/chrome_todo_5.jpg" alt="Loading data on launch"></p>

<p>In the code snippet shown above, &quot;obj.todos&quot; is used to refer to the data we saved (remember the key in the key/value pair we used while saving?). If the data is present in the storage, it will be saved to a global variable &quot;stored_todos&quot; which we can then read in the window (in <strong>application.js</strong>). But first we need to &quot;get&quot; the background page and in the resulting callback, we&#39;ll copy the value to window:</p>

<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">chrome</span><span class="p">.</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">getBackgroundPage</span><span class="p">(</span>
        <span class="kd">function</span> <span class="p">(</span><span class="nx">bg_page</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Read the stored todos from the background page and save it to the window</span>
            <span class="c1">// Note: &quot;window&quot; variables can created on the fly...</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">bg_page</span><span class="p">.</span><span class="nx">stored_todos</span><span class="p">);</span>
            <span class="nb">window</span><span class="p">.</span><span class="nx">stored_todos</span> <span class="o">=</span> <span class="nx">bg_page</span><span class="p">.</span><span class="nx">stored_todos</span><span class="p">;</span>

            <span class="c1">// Update the textarea with the stored todos</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">stored_todos</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
                <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">stored_todos</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">);</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;enter&#39;</span><span class="p">).</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39;\r\n&#39;</span><span class="p">;</span>
        <span class="nx">txt</span> <span class="o">+=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;output&#39;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">txt</span><span class="p">;</span>

        <span class="c1">// Save data to storage</span>
        <span class="nx">chrome</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">sync</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span><span class="s1">&#39;todos&#39;</span><span class="o">:</span> <span class="nx">txt</span><span class="p">},</span>
            <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;todos saved...&#39;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">);</span>
    <span class="p">};</span>
<span class="p">};</span></code></pre></div>

<p>Reload the app now and you should be able to see the textarea initialized with the values that were saved earlier.</p>


      </section>
      <footer>
        
tactile-theme is maintained by <a href="https://github.com/jasonlong">jasonlang</a><br/>
jekyll-tactile-theme is maintained by <a href="https://github.com/ankur-gupta">ankur-gupta</a><br/>
This page was generated by <a href="http://pages.github.com">GitHub Pages</a>. Tactile theme by <a href="https://twitter.com/jasonlong">Jason Lang</a>.
      </footer>
    </div>
  </div>
</body>

</html>
